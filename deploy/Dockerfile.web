# Stage 1: Build (VITE_* vars baked at build time via args)
FROM node:22-alpine AS builder
ARG VITE_AUTH_MODE=logto
ARG VITE_LOGTO_ENDPOINT
ARG VITE_LOGTO_APP_ID
ARG VITE_SHOW_DEV_PAGES
ARG VITE_APP_VERSION=dev
ARG VITE_ENV_NAME
RUN corepack enable pnpm
WORKDIR /app
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json tsconfig.base.json ./
COPY packages/shared/package.json packages/shared/
COPY apps/web/package.json apps/web/
RUN pnpm install --frozen-lockfile
COPY packages/shared packages/shared
COPY apps/web apps/web
RUN pnpm --filter @ternity/shared build
RUN pnpm --filter @ternity/web build

# Stage 2: Serve static files
FROM caddy:2-alpine
COPY deploy/Caddyfile.web /etc/caddy/Caddyfile
COPY --from=builder /app/apps/web/dist /srv
EXPOSE 80
