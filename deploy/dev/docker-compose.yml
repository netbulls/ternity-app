name: ternity-app-dev

services:
  api:
    build:
      context: ../src
      dockerfile: deploy/Dockerfile.api
    container_name: ternity-app-dev-api
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgres://ternity:${DB_PASSWORD}@postgres:5432/ternity
      - AUTH_MODE=logto
      - LOGTO_ENDPOINT=${LOGTO_ENDPOINT}
      - LOGTO_APP_ID=${LOGTO_APP_ID}
      - LOGTO_M2M_APP_ID=${LOGTO_M2M_APP_ID}
      - LOGTO_M2M_APP_SECRET=${LOGTO_M2M_APP_SECRET}
      - PORT=3010
      - CORS_ORIGIN=https://dev.app.ternity.xyz
    networks:
      - internal
      - proxy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
    security_opt:
      - no-new-privileges:true

  web:
    build:
      context: ../src
      dockerfile: deploy/Dockerfile.web
      args:
        - VITE_AUTH_MODE=logto
        - VITE_LOGTO_ENDPOINT=${VITE_LOGTO_ENDPOINT}
        - VITE_LOGTO_APP_ID=${VITE_LOGTO_APP_ID}
        - VITE_SHOW_DEV_PAGES=true
    container_name: ternity-app-dev-web
    networks:
      - proxy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
    security_opt:
      - no-new-privileges:true

  sync:
    build:
      context: ../src
      dockerfile: deploy/Dockerfile.api
    container_name: ternity-app-dev-sync
    command: ["node", "apps/api/dist/sync-service.js"]
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgres://ternity:${DB_PASSWORD}@postgres:5432/ternity
      - TOGGL_API_TOKEN=${TOGGL_API_TOKEN}
      - TOGGL_WORKSPACE_ID=${TOGGL_WORKSPACE_ID}
      - TOGGL_ORGANIZATION_ID=${TOGGL_ORGANIZATION_ID}
      - TIMETASTIC_API_TOKEN=${TIMETASTIC_API_TOKEN}
      - SYNC_FREQUENT_HOURS=${SYNC_FREQUENT_HOURS:-4}
      - SYNC_DAILY_HOUR_UTC=${SYNC_DAILY_HOUR_UTC:-3}
    networks:
      - internal
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
    security_opt:
      - no-new-privileges:true

  postgres:
    image: postgres:17-alpine
    container_name: ternity-app-dev-db
    environment:
      - POSTGRES_DB=ternity
      - POSTGRES_USER=ternity
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - app_data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ternity -d ternity"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
    security_opt:
      - no-new-privileges:true

networks:
  internal:
  proxy:
    external: true

volumes:
  app_data:
